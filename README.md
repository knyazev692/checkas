# MicroSIP Manager API

–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è MicroSIP —á–µ—Ä–µ–∑ REST API —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–º DND.

## üåü –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **REST API –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π HTTP API –≤–º–µ—Å—Ç–æ TCP/UDP
- **–£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DND** - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å —Å—Ç–∞—Ç—É—Å "–ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å" —á–µ—Ä–µ–∑ Windows API
- **Heartbeat —Å–∏—Å—Ç–µ–º–∞** - –∫–ª–∏–µ–Ω—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 7 —Å–µ–∫—É–Ω–¥
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ MicroSIP** - offline/online/dnd
- **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- **–°–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º** - –∫–ª–∏–µ–Ω—Ç –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ MicroSIP
- **–ú—É–ª—å—Ç–∏—Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îú‚îÄ‚îÄ client/                    # –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å
‚îÇ   ‚îú‚îÄ‚îÄ api_client_stable.py   # –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–µ–Ω—Ç —Å Flask —Å–µ—Ä–≤–µ—Ä–æ–º (–ø–æ—Ä—Ç 8084)
‚îÇ   ‚îî‚îÄ‚îÄ start_stable_client.bat # –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ examples/                  # –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ admin_dnd_control.py   # –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è DND –∫–ª–∏–µ–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ get_client_status.py   # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ server_control_example.py # –ü—Ä–∏–º–µ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º
‚îÇ   ‚îî‚îÄ‚îÄ README_DND_CONTROL.md  # –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é DND
‚îÇ
‚îú‚îÄ‚îÄ docs/                      # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ API_REFERENCE.md       # –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
‚îÇ
‚îú‚îÄ‚îÄ scripts/                   # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ setup_token.py         # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub —Ç–æ–∫–µ–Ω–∞
‚îÇ   ‚îî‚îÄ‚îÄ migrate_to_api.py      # –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—ã–π API
‚îÇ
‚îú‚îÄ‚îÄ api_config.py              # –û–±—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ requirements.txt           # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ pyproject.toml            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 2. –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞

```bash
# –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç Flask —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8084)
python client/api_client_stable.py

# –ò–ª–∏ —á–µ—Ä–µ–∑ batch —Ñ–∞–π–ª
client/start_stable_client.bat
```

## üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DND —Å—Ç–∞—Ç—É—Å–æ–º

### –ß–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç:
```bash
python examples/admin_dnd_control.py
```

### –ß–µ—Ä–µ–∑ curl:
```bash
# –í—ã–∫–ª—é—á–∏—Ç—å DND
curl -X POST "http://server:8083/api/clients/HOSTNAME/set_dnd?enabled=false"

# –í–∫–ª—é—á–∏—Ç—å DND
curl -X POST "http://server:8083/api/clients/HOSTNAME/set_dnd?enabled=true"
```

### –ß–µ—Ä–µ–∑ Python:
```python
import requests

# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞
response = requests.get("http://server:8083/api/clients/HOSTNAME/status")
status = response.json()

# –£–ø—Ä–∞–≤–ª—è—Ç—å DND
requests.post("http://server:8083/api/clients/HOSTNAME/set_dnd", 
              params={"enabled": False})
```

## üìä API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ API (–ø–æ—Ä—Ç 8083):
- `GET /api/clients` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- `GET /api/clients/{hostname}/status` - –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞ (–æ–ø—Ä–æ—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)
- `POST /api/clients/{hostname}/set_dnd` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DND —Å—Ç–∞—Ç—É—Å–æ–º
- `POST /api/heartbeat` - –ø—Ä–∏—ë–º heartbeat –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
- `GET /api/calls` - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–≤–æ–Ω–∫–∏
- `GET /api/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ API (–ø–æ—Ä—Ç 8084):
- `GET /health` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤–æ—Å—Ç–∏
- `GET /api/status` - –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞
- `POST /api/set_dnd` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DND —á–µ—Ä–µ–∑ Windows API
- `POST /api/get_setting` - –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ MicroSIP
- `POST /api/display_message` - –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [docs/API_REFERENCE.md](docs/API_REFERENCE.md)

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `api_config.py`:
```python
# API —Å–µ—Ä–≤–µ—Ä—ã (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
API_SERVERS = [
    "http://172.16.99.12:8083",  # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
    "http://172.16.99.31:8083",  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä 1
    "http://172.16.99.112:8083",  # –†–µ–∑–µ—Ä–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä 2
]

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
HEARTBEAT_INTERVAL = 7  # Heartbeat –∫–∞–∂–¥—ã–µ 7 —Å–µ–∫—É–Ω–¥
API_TIMEOUT = 10
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
- `API_SERVER_1` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
- `HEARTBEAT_INTERVAL` - –∏–Ω—Ç–µ—Ä–≤–∞–ª heartbeat
- `LOG_LEVEL` - —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ü–æ—Ä—Ç 8084 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è API —Å–µ—Ä–≤–µ—Ä–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ firewall –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
- GitHub —Ç–æ–∫–µ–Ω—ã –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- –õ–æ–≥–∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **Python 3.8+**
- **Windows 10/11** (–¥–ª—è Windows API)
- **MicroSIP** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- **–°–µ—Ç–µ–≤—ã–µ –ø–æ—Ä—Ç—ã:**
  - 8083 - FastAPI —Å–µ—Ä–≤–µ—Ä
  - 8084 - Flask –∫–ª–∏–µ–Ω—Ç (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω —Å–µ—Ä–≤–µ—Ä—É)

## üéØ –°—Ç–∞—Ç—É—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤

| –°—Ç–∞—Ç—É—Å | –≠–º–æ–¥–∑–∏ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|----------|
| `offline` | ‚ö´ | MicroSIP –Ω–µ –∑–∞–ø—É—â–µ–Ω |
| `online` | üü¢ | MicroSIP –∑–∞–ø—É—â–µ–Ω, –¥–æ—Å—Ç—É–ø–µ–Ω |
| `dnd` | üî¥ | MicroSIP –∑–∞–ø—É—â–µ–Ω, DND –≤–∫–ª—é—á–µ–Ω |

## üîÑ Heartbeat —Å–∏—Å—Ç–µ–º–∞

–ö–ª–∏–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç heartbeat –∫–∞–∂–¥—ã–µ **7 —Å–µ–∫—É–Ω–¥**:

```json
POST http://server:8083/api/heartbeat
{
  "hostname": "NIKITA",
  "extension": "485", 
  "status": 0
}
```

–ì–¥–µ `status`: 0 = –¥–æ—Å—Ç—É–ø–µ–Ω, 1 = DND

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞:
- `client/api_client_stable.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–µ–Ω—Ç —Å Flask —Å–µ—Ä–≤–µ—Ä–æ–º
- `server/api_server.py` - FastAPI —Å–µ—Ä–≤–µ—Ä —Å SQLite –ë–î
- `examples/` - –≥–æ—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
1. –î–æ–±–∞–≤–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤ `server/api_server.py`
2. –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç –≤ `client/api_client_stable.py`
3. –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–º–µ—Ä –≤ `examples/`
4. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ `docs/API_REFERENCE.md`

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [API_REFERENCE.md](docs/API_REFERENCE.md) - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- [README_DND_CONTROL.md](examples/README_DND_CONTROL.md) - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DND –∫–ª–∏–µ–Ω—Ç–æ–≤
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö: `python examples/admin_dnd_control.py --help`

## üöÄ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ú–∞—Å—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DND (–æ–±–µ–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤):
```python
import requests

server = "http://172.16.99.123:8083"
clients = requests.get(f"{server}/api/clients").json()

# –í–∫–ª—é—á–∏—Ç—å DND –¥–ª—è –≤—Å–µ—Ö
for client in clients:
    requests.post(f"{server}/api/clients/{client['hostname']}/set_dnd", 
                  params={"enabled": True})
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞:
```bash
# –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–ª–∏–µ–Ω—Ç–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
python examples/get_client_status.py NIKITA monitor 10
```

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å—Ä–µ–¥–µ.

---

**–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üéâ

–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
1. `python server/api_server.py` (—Å–µ—Ä–≤–µ—Ä)
2. `python client/api_client_stable.py` (–∫–ª–∏–µ–Ω—Ç) 
3. `python examples/admin_dnd_control.py` (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
